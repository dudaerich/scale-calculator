<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="utf-8">
    <title data-text-ref="scale-calculator"></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
    <link rel="stylesheet" href="./languages.min.css">
    <link rel="stylesheet" href="./index.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>
    <script src="texts.js"></script>
    <script src="systems.js"></script>
  </head>
  <body>
    <div class="container-fluid application-content">
      <div class="row text-center">
        <div class="logo">
          <a href="https://www.mzk.cz/"><img data-text-ref="mzk-logo-src" data-text-target="src" width="90px" src="mzk-logo.png"></a>
        </div>
        <div class="languages">
          <a href="javascript:switchLang('cs')" class="btn btn-link"><span class="lang-sm" lang="cs"></span></a>
          <a href="javascript:switchLang('de')" class="btn btn-link"><span class="lang-sm" lang="de"></span></a>
          <a href="javascript:switchLang('en')" class="btn btn-link"><span class="lang-sm" lang="en"></span></a>
        </div>
        <div class="title">
          <h1 data-text-ref="scale-calculator"></h1>
          <a href="javascript:showHelp()"><img data-text-ref="about-app" data-text-target="alt" src="help.svg"></a>
        </div>
      </div>
      <div class="row form-inline text-center">
        <div class="inline">
          <div data-text-ref="system"></div>
          <div>
            <select id="input-system" class="form-control"></select>
          </div>
        </div>
        <input id="input-value-mm" type="text" class="form-control" value="100">
        <span>mm </span><span data-text-ref="na-mape-je"></span>
        <input id="input-value-unit" type="text" class="form-control" value="1">
        <select id="input-unit" class="form-control"></select>
        <span data-text-ref="ve-skutecnosti"></span>
      </div>
      <div class="row text-center"><span id="output"><span id="output-prefix">1:</span><span id="output-value"></span></span></div>
    </div>
    <div id="map" class="map map-content"></div>

    <select id="layer-switcher" class="ol-control"></select>

    <div id="help-dialog" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" data-text-ref="scale-calculator"></h4>
          </div>
          <div data-text-ref="help-text" class="modal-body">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal" data-text-ref="close"></button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <script src="./map.js"></script>
    <script>

      var lang = 'cs';

      var valueMmInput = $('#input-value-mm');
      var valueUnitInput = $('#input-value-unit');
      var systemInput = $('#input-system');
      var unitInput = $('#input-unit');
      var valueOutput = $('#output-value');
      var layerSwitcher = $('#layer-switcher');

      var systemMap = {};
      systems.forEach(function(system) {
        var unitMap = {};

        system.units.forEach(function(unit) {
          unitMap[unit.id] = unit;
        });

        system.unitMap = unitMap;
        systemMap[system.id] = system;
      });

      valueMmInput.on('keyup', function() {
        updateOutput();
      });

      valueUnitInput.on('keyup', function() {
        updateOutput();
        clearMap();
      });

      systemInput.on('change', function() {
        updateUnits(systemInput.val());
        updateOutput();
        clearMap();
      });

      unitInput.on('change', function() {
        updateOutput();
        clearMap();
      });

      $('#output-prefix').on('click', function(e) {
        select(e.target.parentElement);
      });

      $('#output-value').on('click', function(e) {
        select(e.target);
      });

      function select(element) {
        var range = document.createRange();
        range.selectNodeContents(element);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        try {
          document.execCommand('copy');
        } catch (err) {
        }
      };

      systems.forEach(function(system) {
        systemInput.append($('<option>', {
          'value': system.id,
          'data-text-ref': system.id
        }));
      });

      updateUnits(systemInput.val());

      for (var k in window.mapLayers) {
        layerSwitcher.append($('<option>', {
          'value': k,
          'data-text-ref': k
        }));
      }

      layerSwitcher.on('change', function() {
        switchLayer(layerSwitcher.val());
      });

      updateTexts();

      updateOutput();

      function updateOutput() {
        var systemId = systemInput.val();
        var unitId = unitInput.val();
        var ratio = parseFloat(systemMap[systemId].unitMap[unitId].value);
        var inputMm = parseFloat(valueMmInput.val().replace(',', '.'));
        var inputUnit = parseFloat(valueUnitInput.val().replace(',', '.'));

        if (inputMm === NaN || inputUnit === NaN) {
          valueOutput.empty();
        } else {
          var value = Math.round(inputUnit * ratio / inputMm);
          valueOutput.empty().append(value);
        }
      }

      function updateUnits(systemId) {
        var system = systemMap[systemId];
        unitInput.empty();
        system.units.forEach(function(unit) {
          unitInput.append($('<option>', {
            value: unit.id,
            'data-text-ref': unit.id
          }));
        });
        updateTexts();
      }

      function switchLang(l) {
        lang = l;
        updateTexts();
      }

      function updateTexts() {
        $('[data-text-ref]').each(function (i, e) {
          e = $(e);
          var text = texts[e.attr('data-text-ref')][lang];
          var target = e.attr('data-text-target');

          if (target) {
            e.attr(target, text);
          } else {
            e.html(text);
          }
        });
      }

      function showHelp(e) {
        $('#help-dialog').modal();
      }

    </script>
  </body>
</html>
